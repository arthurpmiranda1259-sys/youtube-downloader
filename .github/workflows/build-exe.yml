name: Build Windows EXE

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite executar manualmente

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install yt-dlp
    
    - name: ğŸ”¨ Compilar EXE
      run: |
        python build_exe.py
    
    - name: ğŸ“‹ Listar arquivos gerados
      run: |
        dir dist
        if (Test-Path "dist/NeoYT_Downloader_Portable.exe") {
          Write-Host "âœ… EXE criado com sucesso!"
          $size = (Get-Item "dist/NeoYT_Downloader_Portable.exe").Length / 1MB
          Write-Host "ğŸ“Š Tamanho: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ EXE nÃ£o encontrado!"
          exit 1
        }
      shell: pwsh
    
    - name: ğŸ“¦ Criar pacote de distribuiÃ§Ã£o
      run: python create_package.py
    
    - name: ğŸ“¤ Upload do EXE
      uses: actions/upload-artifact@v4
      with:
        name: NeoYT-Downloader-EXE
        path: dist/NeoYT_Downloader_Portable.exe
        retention-days: 30
    
    - name: ğŸ“¤ Upload do pacote completo
      uses: actions/upload-artifact@v4
      with:
        name: NeoYT-Downloader-Package
        path: dist/NeoYT_Downloader_Portable_v1.0.zip
        retention-days: 90
    
    - name: âœ… Resumo
      run: |
        Write-Host ""
        Write-Host "============================================"
        Write-Host "âœ… BUILD CONCLUÃDO COM SUCESSO!"
        Write-Host "============================================"
        Write-Host ""
        Write-Host "ğŸ“¦ Arquivos disponÃ­veis em 'Artifacts':"
        Write-Host "   â€¢ NeoYT_Downloader_Portable.exe"
        Write-Host "   â€¢ NeoYT_Downloader_Portable_v1.0.zip"
        Write-Host ""
        Write-Host "ğŸ’¾ Para baixar:"
        Write-Host "   1. VÃ¡ em 'Actions' no GitHub"
        Write-Host "   2. Clique neste workflow"
        Write-Host "   3. Baixe os 'Artifacts'"
        Write-Host ""
      shell: pwsh

  # Job opcional: criar release automÃ¡tica em tags
  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Baixar artefatos
      uses: actions/download-artifact@v4
      with:
        name: NeoYT-Downloader-Package
    
    - name: ğŸš€ Criar Release
      uses: softprops/action-gh-release@v1
      with:
        files: NeoYT_Downloader_Portable_v1.0.zip
        body: |
          ## ğŸ¬ NeoYT Downloader - Release AutomÃ¡tica
          
          ### ğŸ“¦ Download
          Baixe o arquivo ZIP abaixo e siga as instruÃ§Ãµes no LEIA-ME.txt
          
          ### âœ¨ CaracterÃ­sticas
          - âœ… 100% Portable (nÃ£o precisa instalar)
          - âœ… Python embutido
          - âœ… yt-dlp incluÃ­do
          - âœ… Auto-instala FFmpeg
          - âœ… Interface premium
          
          ### ğŸš€ Como usar
          1. Baixe o ZIP
          2. Extraia a pasta
          3. Execute `INSTALADOR_COMPLETO.bat`
          4. Pronto!
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
